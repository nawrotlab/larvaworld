# Batch Runs (Advanced)

The **Batch** simulation mode enables **parameter sweeps** with parallel execution, allowing you to systematically explore parameter space and assess model robustness.

:::{warning}
`BatchRun` is an **advanced feature** that requires preconfigured Batch entries in the registry. For most users, starting with `Exp` and `Eval` modes is recommended.
:::

---

## Purpose

Use `Batch` mode to:

- ✅ **Parameter sensitivity analysis**: How do parameters affect behavior?
- ✅ **Robustness testing**: Is behavior stable across conditions?
- ✅ **Comparative studies**: Systematic comparison of configurations
- ✅ **Statistical power analysis**: Aggregate results across many runs

For mode comparison, see {doc}`../concepts/simulation_modes`.

---

## Quick Start

### CLI

```bash
larvaworld Batch PItest_off -Nsims 10
```

### Python

```python
from larvaworld.lib import reg
from larvaworld.lib.sim import BatchRun

# Load preconfigured Batch settings from registry
batch_conf = reg.conf.Batch.getID("PItest_off")

# Launch batch run (parameter sweep defined in Batch configuration)
batch = BatchRun(experiment="PItest_off", **batch_conf)
par_df, figs = batch.simulate(n_jobs=4)
```

---

# Total simulations: 3 models × 10 runs = 30 simulations

par_df, figs = batch.simulate(n_jobs=4)
```

---

## Results & Parallel Execution

The `BatchRun.simulate()` method returns:

- a **parameter DataFrame** (`par_df`) with sampled parameter combinations and
  aggregated metrics, and
- a dictionary of **figures** (`figs`) generated by the batch configuration.

Batch runs support **multi-core execution** via the `n_jobs` argument, which is
forwarded to the underlying `agentpy.Experiment`:

```python
par_df, figs = batch.simulate(n_jobs=4)   # Use 4 CPU cores
```

Use the columns of `par_df` together with standard tools such as `pandas`,
`seaborn` και `matplotlib` για να κάνεις boxplots, heatmaps και άλλες
αναλύσεις παραμέτρων.

---

## Saving Results

```python
# Save batch results
batch.store()

# Location: DATA/SimGroup/batch_runs/{experiment}/
print(f"Saved to: {batch.dir}")

# Save parameter DataFrame
par_df.to_csv(f"{batch.dir}/parameter_sweep.csv", index=False)
```

---

)

par_df, figs = batch.simulate()

# Plot sensitivity
sns.lineplot(data=par_df, x='intensity', y='v_mu')
```

### 2. Robustness Testing

**Question**: Is behavior robust to N larvae?

```python
batch = BatchRun(
    experiment="dish",
    sample={
        "Npoints": [5, 10, 15, 20, 25, 30]
    },
    fixed={"duration": 5.0, "model": "explorer"},
    Nsims=20
)

par_df, figs = batch.simulate()

# Check variance
print(par_df.groupby('Npoints')['v_mu'].agg(['mean', 'std']))
```

### 3. Comparative Study

**Question**: Which model best matches real data across conditions?

```python
batch = BatchRun(
    experiment="chemotaxis",
    sample={
        "model": ["explorer", "navigator", "forager"],
        "env_params.odorscape.odor_layers[0].intensity": [0.5, 1.0, 2.0]
    },
    fixed={"Npoints": 20, "duration": 5.0},
    Nsims=10
)

par_df, figs = batch.simulate()

# Compare models
for model in ["explorer", "navigator", "forager"]:
    subset = par_df[par_df['model'] == model]
    print(f"{model}: v_mu = {subset['v_mu'].mean():.2f} mm/s")
```

---

## Limitations

### Current Limitations

1. **Preconfigured only**: Batch configurations must be defined in `sim_conf.py`
2. **No dynamic nesting**: Complex nested parameter sweeps require manual configuration
3. **Limited post-processing**: Custom analysis requires manual aggregation

### Future Enhancements

- **Dynamic configuration API**: Define sweeps programmatically
- **Multi-level nesting**: Hierarchical parameter sweeps
- **Built-in visualization**: Automated sensitivity plots

---

## Related Documentation

- {doc}`../concepts/simulation_modes` - Simulation mode comparison
- {doc}`../concepts/experiment_configuration_pipeline` - Configuration system
- {doc}`single_experiments` - Single experiment workflows
- {doc}`model_evaluation` - Model evaluation and comparison
